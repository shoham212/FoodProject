<!DOCTYPE HTML>
<html>
  <%- include('../partials/head') %>
  <link rel="stylesheet" href="/assets/css/main.css"> <!-- עדכן את הנתיב לפי המיקום האמיתי של הקובץ -->
  <link rel="stylesheet" href="/assets/css/addMeal.css"> <!-- עדכן את הנתיב לפי המיקום האמיתי של הקובץ -->

  <!-- Main -->
  <article id="main">
    <header id="header" class="alt">
        <h1><a href="/">GlucoseMonitor</a></h1>
    </header>  
    <header>
      <h2>Add a New Meal</h2>
    </header>

    <section class="wrapper style5">
      <div class="inner" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items: start;">
        <section class="upload-section" style="grid-column: 1 / 2;">
          <label for="imageUpload" class="upload-label" style="display: block; font-weight: bold; margin-bottom: 10px;">UPLOAD A PICTURE OF YOUR MEAL:</label>
          <div class="upload-box" id="dropZone" onclick="document.getElementById('imageUpload').click();" style="width: 100%; height: 300px; border: 2px dashed #ccc; display: flex; align-items: center; justify-content: center;">
            <span id="upload-text">Click here to upload an image</span>
            <input type="file" id="imageUpload" name="imageFile" accept="image/*" required style="display:none;">
          </div>
        </section>

        <section class="form-section" style="grid-column: 2 / 3;">
          <form id="uploadForm" action="/meal/add" method="POST" enctype="multipart/form-data" style="display: flex; flex-direction: column; gap: 20px;">
            <!-- Meal Date -->
            <div class="form-group">
              <label for="mealDate">Meal Date:</label>
              <input type="date" id="mealDate" name="mealDate" required style="width: 100%; padding: 10px;">
            </div>

            <!-- Meal Type -->
            <div class="form-group">
              <label for="mealType">Meal Type:</label>
              <select id="mealType" name="mealType" required style="width: 100%; padding: 10px;">
                <option value="" disabled selected>Choose a meal type</option>
                <option value="breakfast">Breakfast</option>
                <option value="lunch">Lunch</option>
                <option value="dinner">Dinner</option>
              </select>
            </div>

            <!-- Glucose Level -->
            <div class="form-group">
              <label for="glucoseLevel">Glucose level after meal (2 hours):</label>
              <input type="number" id="glucoseLevel" name="glucoseLevel" placeholder="Enter glucose level" required style="width: 100%; padding: 10px;">
            </div>

            <!-- Submit Button -->
            <div class="form-group" style="text-align: center;">
              <button type="submit" class="button fit primary" style="padding: 10px 20px;">Analyze Image</button>
            </div>
          </form>
        </section>
      </div>
    </section>
  </article>

  <!-- Modal Popup for Detected Food or Error Message -->
  <% if (typeof foodTag !== 'undefined') { %>
  <div id="foodTagModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <% if (foodTag !== 'Not Food') { %>
        <p>Meal successfully added<br>
          Detected food: <strong style="color: black;"><%= foodTag %></strong></p>
      <% } else { %>
        <p>The picture you provided is not food!<br> 
        Please try again.</p>
      <% } %>
    </div>
  </div>

  <script>
    var modal = document.getElementById("foodTagModal");
    var span = document.getElementsByClassName("close")[0];

    modal.style.display = "block";

    span.onclick = function() {
      modal.style.display = "none";
    };

    window.onclick = function(event) {
      if (event.target == modal) {
        modal.style.display = "none";
      }
    };
  </script>
  <% } %>

  <script>
    const dropZone = document.getElementById('dropZone');
    const uploadText = document.getElementById('upload-text');
    const imageUpload = document.getElementById('imageUpload');

    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('dragging');
    });

    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('dragging');
    });

    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('dragging');
      const file = e.dataTransfer.files[0];
      if (file) {
        uploadText.textContent = file.name;
        imageUpload.files = e.dataTransfer.files;
      }
    });

    imageUpload.addEventListener('change', function() {
      const fileName = this.files[0]?.name || "Drag and drop an image here or click to upload";
      uploadText.textContent = fileName;
    });
  </script>
</body>
</html>
